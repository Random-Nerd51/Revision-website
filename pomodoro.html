<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomodoro Timer</title>

    <link rel="stylesheet" href="main.css">
    <link rel="stylesheet" href="theme.css">
</head>

<body class="page-pomodoro">

    <!-- Navigation -->
    <nav class="menu">
        <ul>
            <li><a href="homepage.html">Home</a></li>
            <li><a href="subjects.html">Subjects</a></li>
            <li><a href="pomodoro.html">Pomodoro</a></li>
            <li><a href="pomodoro-settings.html">Pomodoro Settings</a></li>
            <li><a href="settings.html">Settings</a></li>
        </ul>
    </nav>


    <!-- Pomodoro Container -->
    <div class="pomodoro-container" id="pomoBox">
        <h1>Pomodoro Timer</h1>
        
        <div id="weeklyFocus" class="weekly-focus">This week: 0 minutes</div>
        <div id="timerDisplay">25:00</div>

        <div class="controls">
            <button id="startBtn">Start</button>
            <button id="pauseBtn">Pause</button>
            <button id="resetBtn">Reset</button>
        </div>

        <div class="mode-buttons">
            <button data-mode="pomodoro" class="active">Pomodoro</button>
            <button data-mode="short">Short Break</button>
            <button data-mode="long">Long Break</button>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDKCNP1aPfmWL0AXTIOXi1T2FGt_8-sps8",
            authDomain: "revision-app-eb82c.firebaseapp.com",
            projectId: "revision-app-eb82c",
        };
        firebase.initializeApp(firebaseConfig);
    </script>

    <!-- FIXED POMODORO LOGIC -->
    <script>
        // Load settings cleanly
        function loadPomodoroSettings() {
            return {
                work: Number(localStorage.getItem("pomo-work")) || 25,
                short: Number(localStorage.getItem("pomo-short")) || 5,
                long: Number(localStorage.getItem("pomo-long")) || 15,
                bg: localStorage.getItem("pomo-bg") || "var(--card-bg)"
            };
        }

        let settings = loadPomodoroSettings();

        // Apply background
        document.getElementById("pomoBox").style.background = settings.bg;

        let currentMode = "pomodoro";
        let timeLeft = settings.work * 60;
        let timer = null;

        const display = document.getElementById("timerDisplay");

        function updateDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            display.textContent = `${minutes}:${seconds.toString().padStart(2, "0")}`;
        }

        function notify() {
            if (Notification.permission === "granted") {
                new Notification("Timer Finished!", {
                    body: currentMode === "pomodoro" ? "Time for a break!" : "Back to work!"
                });
            }
        }

        function startTimer() {
            if (timer) return;

            timer = setInterval(() => {
                timeLeft--;
                updateDisplay();

                if (timeLeft <= 0) {
                    timeLeft = 0;
                    clearInterval(timer);
                    timer = null;
                    notify();
                }
            }, 1000);
        }

        function pauseTimer() {
            clearInterval(timer);
            timer = null;
        }

        function resetTimer() {
            pauseTimer();

            // Reload settings in case user changed them
            settings = loadPomodoroSettings();

            if (currentMode === "pomodoro") timeLeft = settings.work * 60;
            if (currentMode === "short") timeLeft = settings.short * 60;
            if (currentMode === "long") timeLeft = settings.long * 60;

            document.getElementById("pomoBox").style.background = settings.bg;

            updateDisplay();
        }

        // Button events
        document.getElementById("startBtn").addEventListener("click", startTimer);
        document.getElementById("pauseBtn").addEventListener("click", pauseTimer);
        document.getElementById("resetBtn").addEventListener("click", resetTimer);

        // Mode switching
        document.querySelectorAll(".mode-buttons button").forEach(btn => {
            btn.addEventListener("click", () => {
                document.querySelector(".mode-buttons .active")?.classList.remove("active");
                btn.classList.add("active");

                currentMode = btn.dataset.mode;
                resetTimer();
            });
        });

        // Auto-reload settings when returning to page
        window.addEventListener("focus", () => {
            settings = loadPomodoroSettings();
            resetTimer();
        });

        // Ask for notification permission
        if (Notification.permission !== "granted") {
            Notification.requestPermission();
        }

        updateDisplay();
    </script>

    <script src="theme-engine.js"></script>

    <!-- Apply dark mode on load -->
    <script>
        if (localStorage.getItem("theme") === "dark") {
            document.body.classList.add("dark-mode");
        }
    </script>

</body>
</html>